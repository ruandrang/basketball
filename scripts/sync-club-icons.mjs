import fs from 'node:fs/promises';
import path from 'node:path';

const ROOT = process.cwd();
const RESOURCES_DIR = path.join(ROOT, 'resources');
const PUBLIC_DIR = path.join(ROOT, 'public', 'club-icons');
const MANIFEST_TS = path.join(ROOT, 'src', 'lib', 'club-icons.ts');

async function fileExists(p) {
  try {
    await fs.access(p);
    return true;
  } catch {
    return false;
  }
}

async function main() {
  if (!(await fileExists(RESOURCES_DIR))) {
    console.log('[sync-club-icons] no resources/ directory found; skipping');
    return;
  }

  await fs.mkdir(PUBLIC_DIR, { recursive: true });

  const entries = await fs.readdir(RESOURCES_DIR, { withFileTypes: true });
  const iconFiles = entries
    .filter((e) => e.isFile())
    .map((e) => e.name)
    .filter((n) => /\.(png|jpg|jpeg|webp|svg)$/i.test(n))
    .sort((a, b) => a.localeCompare(b));

  // Copy files to public/club-icons so Next can serve them.
  await Promise.all(
    iconFiles.map(async (name) => {
      const src = path.join(RESOURCES_DIR, name);
      const dst = path.join(PUBLIC_DIR, name);
      await fs.copyFile(src, dst);
    })
  );

  const ts = `// AUTO-GENERATED by scripts/sync-club-icons.mjs\n// Source: /resources/*\n\nexport const CLUB_ICON_FILES = ${JSON.stringify(iconFiles, null, 2)} as const;\n\nexport type ClubIconFile = (typeof CLUB_ICON_FILES)[number];\n`;

  await fs.mkdir(path.dirname(MANIFEST_TS), { recursive: true });
  await fs.writeFile(MANIFEST_TS, ts, 'utf8');

  console.log(`[sync-club-icons] synced ${iconFiles.length} icon(s) to public/club-icons and generated src/lib/club-icons.ts`);
}

main().catch((err) => {
  console.error('[sync-club-icons] failed:', err);
  process.exit(1);
});
